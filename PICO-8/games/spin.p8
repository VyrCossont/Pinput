pico-8 cartridge // http://www.pico-8.com
version 34
__lua__
-- spin vector demo
-- @vyr@demon.social

theta = 0
dart = nil
darts = {}
fire_counter = 0
fire_cooldown = 4

-- sticks
pi_l = 0
pi_r = 2

-- read normalized stick
-- /!\ pico-8 is upside down
function pi_stick(s, pl)
 pl = pl or 0
 local x = pi_axis(s, pl) >> 15
 local y = pi_axis(s + 1, pl) >> 15
 return x, ~y
end

function _init()
 pi_init()
 brightline_init()
end

function brightline_init()
 -- enable sprite 0
 poke(0x5f36, 0b1000)

 -- set each map cell in the
 -- upper left corner to sprites
 -- 0-255 in same order and
 -- shape as their sprite sheet
 -- numbers. this makes tline,
 -- which uses the map,
 -- equivalent to sspr,
 -- which uses the sprite sheet.
 for x = 0, 15 do
  for y = 0, 15 do
   local s = x + y * 16
   mset(x, y, s)
  end
 end
end

function _update60()
 local x, y = pi_stick(pi_l)
 if x != 0 and y != 0 then
  theta = atan2(x, y)
 end

 if fire_counter == 0 then
  x, y = pi_stick(pi_r)
  if abs(x) > 0.5
  or abs(y) > 0.5 then
   add(darts, {
    p = {x = 0, y = 0},
    v = {x = x * 3, y = y * 3}
   })
   fire_counter = fire_cooldown
  end
 else
  fire_counter -= 1
 end

 for i, dart in pairs(darts) do
  if abs(dart.p.x) > 64
  or abs(dart.p.y) > 64 then
   deli(darts, i)
  else
   dart.p.x += dart.v.x
   dart.p.y += dart.v.y
  end
 end
end

function _draw()
 cls()
 pal()
 palt()
 -- use sprite sheet as sprite sheet
 poke(0x5f54, 0x00)

 if not pi_is_inited() then
  ?"waiting for pinput connection..."
  return
 end

 -- set the origin of world space to the middle of the screen
 camera(-64, -64)

 -- blue only
 -- brighten one step
 pal(0, 1)
 pal(1, 12)
 pal(12, 7)
 -- make black opaque
 palt(0, false)

 -- use video memory as sprite sheet
 poke(0x5f54, 0x60)

 for dart in all(darts) do
  local dart_theta = atan2(dart.v.x, dart.v.y)
  vspr(shape_dart, dart.p.x, dart.p.y, 2, 2, dart_theta)
 end
 
 vspr(shape_claw, 0, 0, 3, 3, theta)

 -- reset camera for HUD
 camera()

 -- CPU
 print(stat(1), 2, 2, 8)
end

-->8
-- new format data

-- copy the screen to the screen along a line
-- ax, ay, bx, by: in world space
function brightline(ax, ay, bx, by)
 -- get the camera transform so we can map world space to screen space
 local camera_x, camera_y = camera()
 camera(camera_x, camera_y)

 -- _u, _v: texture coordinates in fractional map cells (not pixels)
 local au, av = (ax - camera_x) / 8, (ay - camera_y) / 8
 local bu, bv = (bx - camera_x) / 8, (by - camera_y) / 8

 -- steps: see https://www.lexaloffle.com/bbs/?pid=93785#p
 local steps = max(abs(bx - ax), abs(by - ay))
 local du, dv = bu - au, bv - av
 tline(
  ax, ay,
  bx, by,
  au, av,
  du / steps,
  dv / steps
 )
end

-- draw transformed vector shape
function vspr(shape, ox, oy, sx, sy, r)
 for path in all(shape) do
  assert(#path >= 1)
  local mx_mirror_h = 1 - 2 * tonum(path.mirror_h)
  local my_mirror_v = 1 - 2 * tonum(path.mirror_v)
  for mx = mx_mirror_h, 1, 2 do
   for my = my_mirror_v, 1, 2 do
    function transform(x, y)
     -- scale
     x *= mx * sx
     y *= my * sy
     -- rotate
     x, y = x * cos(r) - y * sin(r), x * sin(r) + y * cos(r)
     -- transform
     x += ox
     y += oy
     return x, y
    end

    local x1, y1 = transform(unpack(path[1]))
    for i = 2, #path do
     local x2, y2 = transform(unpack(path[i]))
     brightline(x1, y1, x2, y2, path.color)
     x1 = x2
     y1 = y2
    end
   end
  end
 end
end

shape_claw = {
 {
  color = 10,
  mirror_h = false,
  mirror_v = true,
  { -1, 0 },
  { 1, 3 },
  { 3, 2 },
  { 0, 4 },
  { -3, 0 },
 },
}

shape_dart = {
 {
  color = 7,
  mirror_h = false,
  mirror_v = true,
  { 0, 0 },
  { -1, -1 },
  { 2, 0 },
 },
}

shape_splitter = {
 {
  color = 14,
  mirror_h = true,
  mirror_v = true,
  { 0, 6 },
  { 6, 6 },
  { 6, 0 },
 },
 {
  color = 14,
  mirror_h = true,
  mirror_v = true,
  { 6, 6 },
  { 0, 0 },
 },
}

shape_pinwheel = {
 {
  color = 13,
  mirror_h = false,
  mirror_v = false,
  { 0, 0 },
  { 0, -6 },
  { -6, -6 },
  { 0, 0 },
  { 0, 0 },
  { 0, 0 },
  { -6, 0 },
  { -6, 6 },
  { 0, 0 },
  { 0, 6 },
  { 6, 6 },
  { 0, 0 },
  { 6, 0 },
  { 6, -6 },
  { 0, 0 },
 },
}

shape_leprechaun = {
 {
  color = 11,
  mirror_h = true,
  mirror_v = true,
  { 0, 6 },
  { 6, 6 },
  { 6, 0 },
  { 0, 6 },
 },
}

shape_diamond = {
 {
  color = 12,
  mirror_h = true,
  mirror_v = true,
  { -8, 0 },
  { 0, -8 },
 },
}

-->8
#include pinput.lua

__gfx__
000000000f0f0f0f00000000c000000cc000000c00cccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000f0f0f0f00000c000000000000c0000c00c0000c000000000000000000000000000000000000000000000000000000000000000000000000000000000
007007000f0f0f0f000000000000000000000000c000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000f0f0f0f00c0000000000000000000000c000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000
000770000f0f0f0f000000c00000000000000000c000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700f0f0f0f0000000000000000000000000c000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000f0f0f0f000c0000000000000c0000c00c0000c000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000f0f0f0f000000000c000000cc000000c00cccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0101010101010101010101010101010100020003000200030004000000050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
